<!DOCTYPE html>
<html>
<head>
    <title>Performance Test - Railway Simulation</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        #performance-monitor {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 12px;
            line-height: 1.5;
        }
        .metric {
            margin: 2px 0;
        }
        .good { color: #4CAF50; }
        .warning { color: #FF9800; }
        .bad { color: #F44336; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="performance-monitor">
        <div class="metric">FPS: <span id="fps">--</span></div>
        <div class="metric">Memory: <span id="memory">--</span></div>
        <div class="metric">Active Trains: <span id="trains">--</span></div>
        <div class="metric">DOM Updates/sec: <span id="updates">--</span></div>
        <div class="metric">Status: <span id="status">Initializing...</span></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Performance monitoring variables
        let frameCount = 0;
        let lastTime = performance.now();
        let updateCount = 0;
        let lastUpdateCount = 0;
        
        // FPS counter
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                const fps = Math.round((frameCount * 1000) / (now - lastTime));
                document.getElementById('fps').textContent = fps;
                document.getElementById('fps').className = fps >= 30 ? 'good' : fps >= 15 ? 'warning' : 'bad';
                
                // Update DOM updates per second
                const updatesPerSec = updateCount - lastUpdateCount;
                document.getElementById('updates').textContent = updatesPerSec;
                document.getElementById('updates').className = updatesPerSec <= 100 ? 'good' : updatesPerSec <= 200 ? 'warning' : 'bad';
                lastUpdateCount = updateCount;
                
                frameCount = 0;
                lastTime = now;
            }
            requestAnimationFrame(updateFPS);
        }
        
        // Memory monitoring
        function updateMemory() {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                document.getElementById('memory').textContent = used + 'MB';
                document.getElementById('memory').className = used <= 100 ? 'good' : used <= 200 ? 'warning' : 'bad';
            }
        }
        
        // Override common DOM update methods to count them
        const originalSetLatLng = L.Marker.prototype.setLatLng;
        L.Marker.prototype.setLatLng = function() {
            updateCount++;
            return originalSetLatLng.apply(this, arguments);
        };
        
        const originalSetOpacity = L.Marker.prototype.setOpacity;
        L.Marker.prototype.setOpacity = function() {
            updateCount++;
            return originalSetOpacity.apply(this, arguments);
        };
        
        // Start monitoring
        requestAnimationFrame(updateFPS);
        setInterval(updateMemory, 1000);
        
        document.getElementById('status').textContent = 'Performance monitoring active';
        
        // Create a simple map for baseline testing
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Simulate some markers for baseline performance
        let testMarkers = [];
        for (let i = 0; i < 75; i++) {
            const lat = 20.5937 + (Math.random() - 0.5) * 20;
            const lng = 78.9629 + (Math.random() - 0.5) * 30;
            const marker = L.marker([lat, lng]).addTo(map);
            testMarkers.push(marker);
        }
        
        document.getElementById('trains').textContent = testMarkers.length;
        
        // Animate markers to simulate movement
        setInterval(() => {
            testMarkers.forEach(marker => {
                const pos = marker.getLatLng();
                const newLat = pos.lat + (Math.random() - 0.5) * 0.01;
                const newLng = pos.lng + (Math.random() - 0.5) * 0.01;
                marker.setLatLng([newLat, newLng]);
            });
        }, 2000);
        
        console.log('Performance test initialized with', testMarkers.length, 'test markers');
    </script>
</body>
</html>