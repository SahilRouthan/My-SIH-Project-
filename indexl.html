<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Train Simulation on Tracks (Leaflet)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; }
    #map { position:absolute; top:0; bottom:0; right:0; left:0; }
    .controls {
      position: absolute;
      left: 8px; top: 8px;
      background: rgba(255,255,255,0.95);
      padding: 8px; border-radius:6px;
      font-family: sans-serif; z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    .train-icon {
      width: 24px; height: 12px;
      background: #d9534f;
      border-radius:3px;
      border: 2px solid white;
      box-shadow: 0 0 2px rgba(0,0,0,0.6);
      transform-origin: 12px 6px;
    }
    .train-label {
      font-size: 11px; font-weight: bold; color: black;
      background: rgba(255,255,255,0.7);
      padding: 1px 4px; border-radius:2px;
      margin-top:2px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <button id="btnPlay">▶ Play</button>
    <button id="btnPause">⏸ Pause</button>
    <br/>
    Speed: <input id="speedInput" type="number" value="60" style="width:60px"/> km/h
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // === Map setup ===
  const map = L.map('map').setView([23.0,78.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let routeCoords = null;
  const fallbackRoute = [
    [77.083,28.704],[77.1,28.71],[77.12,28.72],[77.14,28.73],[77.16,28.74]
  ];

  // Try loading railway track
  fetch("india_railways.geojson").then(r=>r.json()).then(j=>{
    if (j.features.length > 0) {
      let f = j.features.find(f=>f.geometry.type==="LineString");
      if (f) {
        routeCoords = f.geometry.coordinates;
      }
    }
    if (!routeCoords) routeCoords = fallbackRoute;
    startSimulation();
  }).catch(()=>{
    console.log("No railway file, using fallback route");
    routeCoords = fallbackRoute;
    startSimulation();
  });

  // === Helpers ===
  function latLngFromCoord(c){ return L.latLng(c[1],c[0]); }
  function getPolylineLength(coords){
    let len=0;
    for(let i=1;i<coords.length;i++){
      len+=latLngFromCoord(coords[i-1]).distanceTo(latLngFromCoord(coords[i]));
    }
    return len;
  }
  function interpolateOnLine(coords,d){
    if(d<=0) return latLngFromCoord(coords[0]);
    let acc=0;
    for(let i=1;i<coords.length;i++){
      const A=latLngFromCoord(coords[i-1]);
      const B=latLngFromCoord(coords[i]);
      const seg=A.distanceTo(B);
      if(acc+seg>=d){
        const t=(d-acc)/seg;
        return L.latLng(A.lat+(B.lat-A.lat)*t, A.lng+(B.lng-A.lng)*t);
      }
      acc+=seg;
    }
    return latLngFromCoord(coords[coords.length-1]);
  }
  function bearing(a,b){
    const φ1=a.lat*Math.PI/180, φ2=b.lat*Math.PI/180;
    const λ1=a.lng*Math.PI/180, λ2=b.lng*Math.PI/180;
    const y=Math.sin(λ2-λ1)*Math.cos(φ2);
    const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
  }

  // === Simulation ===
  let routeLength=0;
  let train=null;
  let playing=false, lastTime=null;

  function startSimulation(){
    // show route
    const latLngs=routeCoords.map(c=>latLngFromCoord(c));
    L.polyline(latLngs,{color:"orange",weight:3}).addTo(map);
    map.fitBounds(L.polyline(latLngs).getBounds(),{padding:[40,40]});

    routeLength=getPolylineLength(routeCoords);
    console.log("Route length (m):",Math.round(routeLength));

    // Create train
    train={
      name:"Express",
      distance:0,
      speedMps:(60*1000/3600), // default 60 km/h
      marker:null
    };
    const pos=interpolateOnLine(routeCoords,0);
    const iconHtml=`<div class="train-icon"></div><div class="train-label">${train.name}</div>`;
    const icon=L.divIcon({className:'train-divicon',html:iconHtml,iconSize:[40,24],iconAnchor:[20,12]});
    train.marker=L.marker(pos,{icon}).addTo(map);
  }

  function animate(ts){
    if(!playing) return;
    if(!lastTime){ lastTime=ts; requestAnimationFrame(animate); return; }
    const dt=(ts-lastTime)/1000; // seconds
    lastTime=ts;

    // update speed from UI
    const speedKmph=parseFloat(document.getElementById("speedInput").value);
    train.speedMps=speedKmph*1000/3600;

    // move
    train.distance+=train.speedMps*dt;
    if(train.distance>routeLength) train.distance=0; // loop

    const pos=interpolateOnLine(routeCoords,train.distance);
    train.marker.setLatLng(pos);

    // rotate icon
    const ahead=interpolateOnLine(routeCoords,Math.min(train.distance+20,routeLength));
    const brng=bearing(pos,ahead);
    const el=train.marker.getElement();
    if(el){ const iconEl=el.querySelector('.train-icon');
      if(iconEl){ iconEl.style.transform=`rotate(${brng}deg)`; }
    }

    requestAnimationFrame(animate);
  }

  // === Controls ===
  document.getElementById("btnPlay").onclick=()=>{
    playing=true; lastTime=null; requestAnimationFrame(animate);
  };
  document.getElementById("btnPause").onclick=()=>{
    playing=false; lastTime=null;
  };

  </script>
</body>
</html>
