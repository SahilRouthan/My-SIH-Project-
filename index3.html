<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>North India Train Simulation</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { height: 100vh; }
    .station-marker { background: red; border-radius: 50%; width: 10px; height: 10px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // Initialize map (centered near Jalandhar)
    const map = L.map('map').setView([31.3, 75.6], 7);

    // Add base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Load railway tracks (blue)
    fetch("india_railways.geojson")
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          style: { color: "blue", weight: 1 }
        }).addTo(map);
      });

    let stationMarkers = {};
    let routeCoords = [];

    // Load stations (red)
    fetch("railway_station.geojson")
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          pointToLayer: (feature, latlng) => {
            let marker = L.circleMarker(latlng, {
              radius: 5,
              fillColor: "red",
              color: "#000",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).bindPopup(feature.properties.name);
            stationMarkers[feature.properties.name] = latlng;
            return marker;
          }
        }).addTo(map);

        // Once stations loaded, plot train
        startTrainSimulation();
      });

    // Train timetable (Amritsar - Delhi Shatabdi)
    const trainSchedule = [
      { station: "Amritsar Junction", departure: "16:50" },
      { station: "Jalandhar City", arrival: "17:50", departure: "17:55" },
      { station: "Phagwara Junction", arrival: "18:15", departure: "18:17" },
      { station: "Ludhiana Junction", arrival: "18:50", departure: "18:55" },
      { station: "Ambala Cantt Junction", arrival: "20:20", departure: "20:25" },
      { station: "New Delhi", arrival: "22:50" }
    ];

    function parseTime(t) {
      let [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    function startTrainSimulation() {
      // Build route from timetable
      for (let stop of trainSchedule) {
        if (stationMarkers[stop.station]) {
          routeCoords.push(stationMarkers[stop.station]);
        } else {
          console.warn("Station not found in GeoJSON:", stop.station);
        }
      }

      // Draw green route
      let routeLine = L.polyline(routeCoords, { color: "green", weight: 3 }).addTo(map);
      map.fitBounds(routeLine.getBounds());

      // Train marker ðŸš†
      let trainIcon = L.divIcon({ className: 'train-icon', html: "ðŸš†", iconSize: [24, 24] });
      let trainMarker = L.marker(routeCoords[0], { icon: trainIcon }).addTo(map);

      // Simulation (1 min = 1 sec)
      let currentLeg = 0;
      function moveTrain() {
        if (currentLeg >= routeCoords.length - 1) return;

        let startStation = trainSchedule[currentLeg];
        let endStation = trainSchedule[currentLeg + 1];
        let startTime = parseTime(startStation.departure || startStation.arrival);
        let endTime = parseTime(endStation.arrival || endStation.departure);

        let duration = endTime - startTime; // minutes
        let steps = duration; // 1 step per minute
        let stepCount = 0;

        let start = routeCoords[currentLeg];
        let end = routeCoords[currentLeg + 1];

        let interval = setInterval(() => {
          stepCount++;
          let lat = start.lat + (end.lat - start.lat) * (stepCount / steps);
          let lng = start.lng + (end.lng - start.lng) * (stepCount / steps);
          trainMarker.setLatLng([lat, lng]);

          if (stepCount >= steps) {
            clearInterval(interval);
            currentLeg++;
            moveTrain();
          }
        }, 1000); // 1 sec = 1 train minute
      }

      moveTrain();
    }
  </script>
</body>
</html>